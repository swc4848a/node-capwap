#!/bin/bash

# while-menu: a menu-driven system information program
DELAY=1 # Number of seconds to display results
DELAY_LONG=10 # Number of seconds to display results for long
RESPONDER_CONF="/etc/fdresponder/fdresponder.properties"
DEPLOY_RULES="/etc/fdresponder/deploy_rules.conf"

# trap ctrl-c and call ctrl_c()
trap ctrl_c INT

function ctrl_c() {
    echo "Invalid entry."
}

while true; do
  clear
  cat << _EOF_
Please Select:

1. Set IP Address
2. Set External FortiManager Server IP Address (Default FortiManager)
3. Set Different FortiManager IP Address base on SN
4. Show Configuration
5. Change Password For Admin

_EOF_

  read -p "Enter selection [1-5] > "

  if [[ $REPLY =~ ^[0-5]$ ]]; then
    case $REPLY in
      1)
        nmtui
        IP=$(ip addr | grep global | cut -d' ' -f 6 | cut -d'/' -f 1)
        sed -i -e '/fdmgrsvr/cfdmgrsvr='$IP':541    # the IP address of forticloud responder tool/' $RESPONDER_CONF
        cat $RESPONDER_CONF | grep fdmgrsvr
        sleep $DELAY
        continue
        ;;
      2)
        read -p "Enter External FortiManager Server IP Address (Default FortiManager) > "
        if [[ $REPLY =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        sed -i -e '/external_fmg_server/cexternal_fmg_server='$REPLY'   # the IP address of external FortiManager server (default FMG)/' $RESPONDER_CONF
        cat $RESPONDER_CONF | grep external_fmg_server
        else
        echo "IP Format Invalid"
        fi
        sleep $DELAY
        continue
        ;;
      3)
        read -p "Enter FortiManager IP Address base on SN > "
        if [[ $REPLY =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        IP=$REPLY
        read -p "Enter FortiGate SN > "
        echo $REPLY" "$IP >> $DEPLOY_RULES
        cat $DEPLOY_RULES
        else
        echo "IP Format Invalid"
        fi
        sleep $DELAY
        continue
        ;;
      4)
        echo "External FortiManager Server Configuration: "
        cat $RESPONDER_CONF
        echo "===================================="
        echo "FortiManager IP Address base on SN: "
        cat $DEPLOY_RULES
        sleep $DELAY_LONG
        continue
        ;;
      5)
        passwd admin
        sleep $DELAY
        continue
        ;;
      0)
        break
        ;;
    esac
  else
    echo "Invalid entry."
    sleep $DELAY
  fi
done
echo "Program terminated."
